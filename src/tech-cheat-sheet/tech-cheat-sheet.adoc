:toc: left
:toclevels: 4
= Technical Cheat Sheet

A collection of helpful commands. Many are basic and given the popularity of Terraform/Ansible/Cloud-Init I'm not sure how often I'll really need to revisit these but anyway they've helped me out over the years and everyone needs to start somewhere. :)

== Linux

=== CentOS
==== Add VLAN to network interface
```bash
# Add VLAN tag to network interface
sudo su -
modprobe --first-time 8021q

# Variables
export VLANID=1055              # VLAN ID
export NETINT=ens192            # Network Interface
export IP=192.168.1.10          # IP Address
export SUB=24                   # Subnet Prefix
export NETID=192.168.1.0        # Network ID

# Create files
cat << EOF > /etc/sysconfig/network-scripts/ifcfg-$NETINT
DEVICE=$NETINT
TYPE=Ethernet
BOOTPROTO=none
ONBOOT=yes
EOF

cat << EOF > /etc/sysconfig/network-scripts/ifcfg-$NETINT.$VLANID
DEVICE=$NETINT.$VLANID
BOOTPROTO=none
ONBOOT=yes
IPADDR=$IP
PREFIX=$SUB
NETWORK=$NETID
VLAN=yes
EOF
```

==== Basic commands

```bash
# Create User Account
adduser username

# Specify password
passwd password

# Add user account to wheel, to allow sudo access
usermod -aG wheel username

# View HBA and Driver info
cat /proc/scsi/qla2xxx/0

# Display permissions
ls -lt

# Change permissions
chmod a+wr <filename>

# Firewall Commands
sudo systemctl stop firewalld
sudo systemctl start firewalld
sudo systemctl enable firewalld
sudo systemctl status firewalld

# Delete folder and everything under it - careful!
rm -rf .git

# Show Storage Information
blkid
lsblk

# See memory usage
free -h
```
==== Grow a file system
```bash
First, extend the vmdk by whatever size. In this example, we resized from 15GB to 60GB.
 
# Need to either reboot VM or run:
 
echo 1 > /sys/block/sda/device/rescan
 
#
# Once rebooted, confirm that /dev/sda is 60GB…
#
[root@server ~]# cat /proc/partitions
major minor  #blocks  name
 
   8        0   62914560 sda ß--------------------- now 60GB
   8        1    1048576 sda1
   8        2   15727616 sda2
  11        0    1048575 sr0
253        0   14045184 dm-0
253        1    1679360 dm-1
[root@server ~]# 
 
#
# You then need to resize the /dev/sda2 partition by deleting it and recreating it in fdisk. The data will remain intact just don't screw it up!
# 
[root@server ~]# fdisk /dev/sda
Welcome to fdisk (util-linux 2.23.2).
 
Changes will remain in memory only, until you decide to write them.
Be careful before using the write command.
 
 
Command (m for help): p
 
Disk /dev/sda: 64.4 GB, 64424509440 bytes, 125829120 sectors
Units = sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
Disk label type: dos
Disk identifier: 0x00038d8d
 
   Device Boot      Start         End      Blocks   Id  System
/dev/sda1   *        2048     2099199     1048576   83  Linux
/dev/sda2         2099200    33554431    15727616   8e  Linux LVM ß----- paritition to grow from 15GB to 60GB
 
Command (m for help): d
Partition number (1,2, default 2): d
Partition number (1,2, default 2): 2
Partition 2 is deleted
 
Command (m for help): n
Partition type:
   p   primary (1 primary, 0 extended, 3 free)
   e   extended
Select (default p): p
Partition number (2-4, default 2): 2
First sector (2099200-125829119, default 2099200): 2099200
Last sector, +sectors or +size{K,M,G} (2099200-125829119, default 125829119): 125829119
Partition 2 of type Linux and of size 59 GiB is set
 
Command (m for help): t
Partition number (1,2, default 2): 2
Hex code (type L to list all codes): 8e
Changed type of partition 'Linux' to 'Linux LVM'
 
Command (m for help): p
 
Disk /dev/sda: 64.4 GB, 64424509440 bytes, 125829120 sectors
Units = sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
Disk label type: dos
Disk identifier: 0x00038d8d
 
   Device Boot      Start         End      Blocks   Id  System
/dev/sda1   *        2048     2099199     1048576   83  Linux
/dev/sda2         2099200   125829119    61864960   8e  Linux LVM ß----- now 60GB. don’t forget to set Type of 8e
 
Command (m for help): w
The partition table has been altered!
 
Calling ioctl() to re-read partition table.
 
WARNING: Re-reading the partition table failed with error 16: Device or resource busy.
The kernel still uses the old table. The new table will be used at
the next reboot or after you run partprobe(8) or kpartx(8)
Syncing disks.
[root@server ~]# partprobe -s
/dev/sda: msdos partitions 1 2
[root@server ~]#
 
# Now the partition should be 60GB, but you now have to resize the LVM PV..
 
 
[root@server ~]#
[root@server ~]#
[root@server ~]# pvdisplay
  --- Physical volume ---
  PV Name               /dev/sda2
  VG Name               centos
  PV Size               <15.00 GiB / not usable 2.00 MiB
  Allocatable           yes (but full)
  PE Size               4.00 MiB
  Total PE              3839
  Free PE               0
  Allocated PE          3839
  PV UUID               XjhoR5-QBdj-ZTQw-5bd6-4dCt-vE2R-lj6e6y
 
[root@server ~]# pvresize /dev/sda2
  Physical volume "/dev/sda2" changed
  1 physical volume(s) resized or updated / 0 physical volume(s) not resized
[root@server ~]# pvdisplay
  --- Physical volume ---
  PV Name               /dev/sda2
  VG Name               centos
  PV Size               <59.00 GiB / not usable 2.00 MiB
  Allocatable           yes
  PE Size               4.00 MiB
  Total PE              15103
  Free PE               11264
  Allocated PE          3839
  PV UUID               XjhoR5-QBdj-ZTQw-5bd6-4dCt-vE2R-lj6e6y
 
# PV now resized. I once had to stop Docker service to get it to resize… something to look out for.
 
[root@server ~]# vgdisplay
  --- Volume group ---
  VG Name               centos
  System ID
  Format                lvm2
  Metadata Areas        1
  Metadata Sequence No  6
  VG Access             read/write
  VG Status             resizable
  MAX LV                0
  Cur LV                2
  Open LV               2
  Max PV                0
  Cur PV                1
  Act PV                1
  VG Size               <59.00 GiB
  PE Size               4.00 MiB
  Total PE              15103
  Alloc PE / Size       3839 / <15.00 GiB
  Free  PE / Size       11264 / 44.00 GiB
  VG UUID               HHtfVk-nLvn-lUbo-uXU9-2h8V-IcN6-dqKD0Z
 
[root@server ~]# lvdisplay
  --- Logical volume ---
  LV Path                /dev/centos/swap
  LV Name                swap
  VG Name                centos
  LV UUID                qzvWad-rsGy-lpSe-6DZ2-S44k-Vr6y-NE6c1a
  LV Write Access        read/write
  LV Creation host, time localhost, 2019-10-10 08:53:32 +1100
  LV Status              available
  # open                 2
  LV Size                1.60 GiB
  Current LE             410
  Segments               1
  Allocation             inherit
  Read ahead sectors     auto
  - currently set to     8192
  Block device           253:1
 
  --- Logical volume ---
  LV Path                /dev/centos/root
  LV Name                root
  VG Name                centos
  LV UUID                lLGFJQ-Xx7r-HKco-GKIr-Myxw-0G6J-dAbxih
  LV Write Access        read/write
  LV Creation host, time localhost, 2019-10-10 08:53:34 +1100
  LV Status              available
  # open                 1
  LV Size                13.39 GiB
  Current LE             3429
  Segments               1
  Allocation             inherit
  Read ahead sectors     auto
  - currently set to     8192
  Block device           253:0
 
# Now grow the LVM LV by adding 44GB (which is all that is available in VG)… resulting LV will be ~60GB (16+44GB).
 
[root@server ~]# lvextend -L +44G /dev/centos/root
  Size of logical volume centos/root changed from 13.39 GiB (3429 extents) to 57.39 GiB (14693 extents).
  Logical volume centos/root successfully resized.
[root@server ~]# lvdisplay
  --- Logical volume ---
  LV Path                /dev/centos/swap
  LV Name                swap
  VG Name                centos
  LV UUID                qzvWad-rsGy-lpSe-6DZ2-S44k-Vr6y-NE6c1a
  LV Write Access        read/write
  LV Creation host, time localhost, 2019-10-10 08:53:32 +1100
  LV Status              available
  # open                 2
  LV Size                1.60 GiB
  Current LE             410
  Segments               1
  Allocation             inherit
  Read ahead sectors     auto
  - currently set to     8192
  Block device           253:1
 
  --- Logical volume ---
  LV Path                /dev/centos/root
  LV Name                root
  VG Name                centos
  LV UUID                lLGFJQ-Xx7r-HKco-GKIr-Myxw-0G6J-dAbxih
  LV Write Access        read/write
  LV Creation host, time localhost, 2019-10-10 08:53:34 +1100
  LV Status              available
  # open                 1
  LV Size                57.39 GiB
  Current LE             14693
  Segments               1
  Allocation             inherit
  Read ahead sectors     auto
  - currently set to     8192
  Block device           253:0
 
# Now grow the XFS filesystem
 
[root@server ~]# df -h /
Filesystem               Size  Used Avail Use% Mounted on
/dev/mapper/centos-root   14G  3.1G   11G  23% /
[root@server ~]# xfs_growfs  /dev/mapper/centos-root
meta-data=/dev/mapper/centos-root isize=512    agcount=4, agsize=877824 blks
         =                       sectsz=512   attr=2, projid32bit=1
         =                       crc=1        finobt=0 spinodes=0
data     =                       bsize=4096   blocks=3511296, imaxpct=25
         =                       sunit=0      swidth=0 blks
naming   =version 2              bsize=4096   ascii-ci=0 ftype=1
log      =internal               bsize=4096   blocks=2560, version=2
         =                       sectsz=512   sunit=0 blks, lazy-count=1
realtime =none                   extsz=4096   blocks=0, rtextents=0
data blocks changed from 3511296 to 15045632
[root@server ~]# df -h /
Filesystem               Size  Used Avail Use% Mounted on
/dev/mapper/centos-root   58G  3.1G   55G   6% /
[root@server ~]#
```
==== Install XRDP
```bash
sudo yum install -y epel-release
sudo yum install -y xrdp
sudo systemctl start xrdp
sudo systemctl enable xrdp
 
# To confirm the port is listening:
sudo netstat -antup | grep xrdp
```

==== Logs
```bash
# Use journalctl to tail logs, in this case sshd logs
journalctl -u sshd -f
```

==== Manage processes

```bash
# Find PID
ps -ef | grep <pid>

# Kill all firefox processes for all users
kill $(pidof firefox)
```

=== Cloud-init

==== Password hashing
```bash
# mkpasswd can be used to generate a hashed password
sudo apt install whois
mkpasswd --method=SHA-512 --rounds=4096
```

=== Docker

==== Export / Import Docker container
```bash
# Export the image to a tar file
docker save -o <path for generated tar file> <image name>

# Import it where you need it
docker load -i <path to image tar file>
```

==== How to use a docker container when specific version of kubectl is required
```bash
docker run --entrypoint ["tail", "-f", "/dev/null"] --name kubectl116 -v /home/user/<username>/.kube/config:/.kube/config bitnami/kubectl:1.16
```

==== Run containers
```bash
# One off busybox
docker run -it --rm busybox
```





==== Start up Racher Server in Dev environment
```bash
sudo docker volume create \
  -d netapp \ # If using NetApp driver
  --name rancherData --opt size=20G

sudo docker run -d --restart=unless-stopped \
  -p 80:80 -p 443:443 \
  -v rancherData:/var/lib/rancher \
  --privileged \
  --name=rancher \
  rancher/rancher:latest
```

=== General

==== Proxy
```bash
# Test proxy with WGET (may need a more recent version of WGET)
wget --spider -e use_proxy=yes -e http_proxy=10.61.39.66:80 www.google.com
```

=== Vim

Occasionally I need to paste data in to a file opened with vim and find that it's indenting. Use the the following to control the paste behavour.

```bash
 :set paste
 :set nopaste
 set pastetoggle=<F2> # Allows you to toggle the paste option using the F2 key
```
Great Vim Cheat Sheet: https://vim.rtorr.com/

